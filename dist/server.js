"use strict";class Interpreter{constructor(e,t){var o=this;this.robot=t,this.variables=[],this.controlTable=[],this.position=0,this.labelTable=[],this.commands=[],this.errorState="",this.labelTable=e.labelTable,this.commands=e.commands,this.controlTable.print=function(e){if("string"==e.value.type||"number"==e.value.type)for(var t in o.robot.room.users)o.robot.room.users[t].socket.emit("message",o.robot.name+":"+e.value.value);else if("variable"==e.value.type)for(var t in o.robot.room.users)o.robot.room.users[t].socket.emit("message",o.robot.name+":"+o.variables[e.value.value]);else for(var t in o.robot.room.users)o.robot.room.users[t].socket.emit("message",o.robot.name+":"+o.solve(e.value))},this.controlTable.shoot=function(e){var t=0;t="number"==e.direction.type?parseInt(e.direction.value):"variable"==e.direction.type?o.variables[e.direction.value]:o.solve(e.direction),o.robot.turretDir=t;var s={x:o.robot.x,y:o.robot.y},r={x:o.robot.x+100*Math.sin(t*Math.PI/180),y:o.robot.y+100*Math.cos(t*Math.PI/180)},i=o.robot.room.robots;for(var n in o.robot.energy-=2,i){if(i[n]!==o.robot)if(inteceptCircleLineSeg({center:{x:i[n].x,y:i[n].y},radius:i[n].size},{p1:s,p2:r}).length>0){i[n].energy-=5;var a=o.robot.room;for(n=0;n<a.users.length;n++)a.users[n].socket.emit("shoot",o.robot.name,i[n].name);return 1}}},this.controlTable.move=function(e){var t=0,s=0;t="number"==e.direction.type?parseInt(e.direction.value):"variable"==e.direction.type?o.variables[e.direction.value]:o.solve(e.direction),s="number"==e.speed.type?parseInt(e.speed.value):"variable"==e.speed.type?o.variables[e.speed.value]:o.solve(e.speed),o.robot.vX+=parseFloat((s*Math.sin(t*Math.PI/180)).toFixed(2)),o.robot.vY+=parseFloat((s*Math.cos(t*Math.PI/180)).toFixed(2)),o.robot.direction=t},this.controlTable.if=function(e){var t=0;if("number"==e.value.type)0==parseInt(e.value.value)&&(t=1);else if("variable"==e.value.type){0==o.variables[e.value.value]&&(t=1)}else{0==o.solve(e.value)&&(t=1)}if(t){o.position++;for(var s=0;o.position<o.commands.length-1&&t;){"if"===(e=o.commands[o.position]).cmd&&s++,"endif"===e.cmd?s>0?s--:t=!1:0===s&&"else"===e.cmd?t=!1:o.position++}}},this.controlTable.endif=function(e){},this.controlTable.else=function(e){o.position++;for(var t=0,s=!0;o.position<o.commands.length-1&&s;){"if"===(e=o.commands[o.position]).cmd&&t++,"endif"===e.cmd?t>0?t--:s=!1:o.position++}},this.controlTable.assign=function(e){"string"==e.value.type||"number"==e.value.type?o.variables[e.variable]=e.value.value:o.variables[e.variable]=o.solve(e.value)},this.controlTable.goto=function(e){var t;t=o.labelTable[e.value]-1,o.position=t},this.functionTable=[],this.functionTable.scan=function(e){if(1===e.length){var t=e[0].value;"op"===e[0].type&&(t=o.solve(e[0])),"variable"==e[0].type&&(t=o.variables[e[0].value]),o.robot.turretDir=t;var s={x:o.robot.x,y:o.robot.y},r={x:o.robot.x+100*Math.sin(t*Math.PI/180),y:o.robot.y+100*Math.cos(t*Math.PI/180)},i=o.robot.room.robots;for(var n in i){if(i[n]!==o.robot)if(inteceptCircleLineSeg({center:{x:i[n].x,y:i[n].y},radius:i[n].size},{p1:s,p2:r}).length>0)return 1}}return 0},this.functionTable.getX=function(e){return o.robot.x},this.functionTable.getY=function(e){return o.robot.y},this.functionTable.getDir=function(e){return o.robot.direction},this.functionTable.sin=function(e){if(e.length>0){var t=e[0].value;return"op"===e[0].type&&(t=o.solve(e[0])),"variable"==e[0].type&&(t=o.variables[e[0].value]),Math.sin(t)}throw"Not enough params"},this.functionTable.cos=function(e){if(e.length>0){var t=e[0].value;return"op"===e[0].type&&(t=o.solve(e[0])),"variable"==e[0].type&&(t=o.variables[e[0].value]),Math.cos(t)}throw"Not enough params"},this.functionTable.rand=function(e){if(e.length>1){var t=e[0].value;"op"===e[0].type&&(t=o.solve(e[0])),"variable"==e[0].type&&(t=o.variables[e[0].value]);var s=e[1].value;return"op"===e[1].type&&(s=o.solve(e[1])),"variable"==e[1].type&&(s=o.variables[e[1].value]),t=parseInt(t),s=parseInt(s),Math.floor(Math.random()*s)+t}throw"Not enough params"}}restart(){this.variables=[],this.position=0,this.errorState=""}step(){if(""===this.errorState&&this.position<this.commands.length){var t=this.commands[this.position];if(null!=this.controlTable[t.cmd])try{this.controlTable[t.cmd](t)}catch(e){console.log(e),this.errorState=e}else console.log("Runtime Error"),this.errorState=e;this.position++}}solve(e){var t=e.left,o=e.right,s="";if(void 0===t&&void 0===o){if(null!=this.functionTable[e.name])return this.functionTable[e.name](e.params)}else switch(t="function"===t.type?this.functionTable[t.name](t.params):"op"===t.type?this.solve(t):"variable"===t.type?this.variables[t.value]:t.value,o="function"===o.type?this.functionTable[o.name](o.params):"op"===o.type?this.solve(o):"variable"===o.type?this.variables[o.value]:o.value,!1===isNaN(t)&&"string"==typeof t&&(t=-1!=t.indexOf(".")?parseFloat(t):parseInt(t)),!1===isNaN(o)&&"string"==typeof o&&(o=-1!=o.indexOf(".")?parseFloat(o):parseInt(o)),e.operator){case"+":s=t+o;break;case"-":s=t-o;break;case"/":s=t/o;break;case"*":s=t*o;break;case"=":s=t===o;break;case"<":s=t<o;break;case">":s=t>o;break;case"!=":s=t!==o;break;case"and":s=t&&o;break;case"or":s=t||o}return s}}class Tokenizer{tokenize(e){for(var t=[],o=0;o<e.length;o++){var s=e[o].split(/([^a-zA-Z0-9])/g);t[o]=[];for(var r=0;r<s.length;r++)""!==s[r].trim()&&t[o].push(s[r])}for(o=0;o<t.length;o++)0===t[o].length&&(t.splice(o,1),o--);var i="search",n=["=","+","-","*","/","<",">","(",")","!"],a=["getX","getY","sin","cos","tan","rand","scan"],h=["if","endif","goto","print","move","else","shoot"],l=[],u="";for(o=0;o<t.length;o++)for(var c=0;c<t[o].length;c++){var p=t[o][c];switch(i){case"search":if(u="",-1!=n.indexOf(p)){var v="op";"="===p&&(v="equals"),"("!==p&&")"!==p||(v="paren"),"!"===p&&c<t[o].length-1&&-1!=n.indexOf(t[o][c+1])&&(p+=t[o][c+1],c++),l.push(new Token(p,v));break}!1===isNaN(p)?(i="number",u=p):'"'===p?i="string":-1!=a.indexOf(p)?l.push(new Token(p,"function")):-1!=h.indexOf(p)?l.push(new Token(p,"control")):(i="word",u=p),c===t[o].length-1&&o===t.length-1&&l.push(new Token(p,i));break;case"number":if("."===p)u+=".";else if("."===u[u.length-1]){if(isNaN(p))return void errorOff("Failed to tokenize line "+o);u+=p}else l.push(new Token(u,"number")),i="search",c--;break;case"string":'"'===p?(l.push(new Token(u,"string")),i="search"):(""!=u&&(u+=" "),u+=p);break;case"word":"_"===p?u+=p:":"===p?(l.push(new Token(u,"label")),i="search"):(l.push(new Token(u,"word")),i="search",c--)}}return{tokens:l}}}class Token{constructor(e,t){this.value=e,this.type=t}}var friction=.2;class Robot{constructor(e,t,o,s,r,i,n,a){var h=(new Tokenizer).tokenize(e),l=(new Parser).prepare(h);"string"!=typeof l?this.interpreter=new Interpreter(l,this):this.stopped=!0,this.turretDir=0,this.size=10,this.energy=100,this.name=a||"Default",this.cpu=t,this.clock=o,this.cycle=0,this.stopped=!1,this.x=s,this.y=r,this.vX=0,this.vY=0,this.direction=i,this.room=n}start(){this.stopped=!1}stop(){this.stopped=!0}update(){if(!1===this.stopped&&this.energy>0&&this.cycle++,this.cycle>=this.clock&&(this.process(),this.energy--,this.cycle=0),!this.stopped&&this.energy<1){this.stopped=!0,this.energy=0;for(var e=this.room,t=0;t<e.users.length;t++)e.users[t].socket.emit("message",this.name+" has been taken offline!");var o=this;setTimeout(function(){o.room.robots.splice(o.room.robots.indexOf(o),1)},1e3)}this.x+=this.vX,this.y+=this.vY,this.vX>0?this.vX-=friction:this.vX<0&&(this.vX+=friction),this.vY>0?this.vY-=friction:this.vY<0&&(this.vY+=friction),this.x>this.room.width&&(this.x=this.room.width,this.vX*=-1),this.x<0&&(this.x=0,this.vX*=-1),this.y>this.room.height&&(this.y=this.room.height,this.vY*=-1),this.y<0&&(this.y=0,this.vY*=-1),this.vY=parseFloat(this.vY.toFixed(2)),this.vX=parseFloat(this.vX.toFixed(2)),this.x=parseFloat(this.x.toFixed(2)),this.y=parseFloat(this.y.toFixed(2))}process(){if(null!=this.interpreter)for(var e=0;e<this.cpu;)this.interpreter.step(),e++}reboot(){this.stop(),this.interpreter.restart(),this.start()}}class Parser{constructor(){this.position=0,this.tokens=[]}prepare(e){this.tokens=e.tokens,e.labelTable=[];for(var t=[];this.position<this.tokens.length-1;)if("word"===this.currentToken().type){var o=this.currentToken();this.position++,"equals"===this.currentToken().type&&(this.position++,t.push({cmd:"assign",variable:o.value,value:this.getExpression()}))}else if("label"===this.currentToken().type)e.labelTable[this.currentToken().value]=t.length,this.position++;else{if("control"!==this.currentToken().type)return"Error, cannot compile: "+this.position+":"+this.currentToken().type+":"+this.currentToken().value;switch(this.currentToken().value){case"print":this.position++;var s=this.getExpression();t.push({type:"control",cmd:"print",value:s});break;case"goto":this.position++;var r=this.currentToken().value;t.push({type:"control",cmd:"goto",value:r}),this.position++;break;case"if":this.position++;s=this.getExpression();t.push({type:"control",cmd:"if",value:s});break;case"endif":t.push({type:"control",cmd:"endif"}),this.position++;break;case"else":t.push({type:"control",cmd:"else"}),this.position++;break;case"move":this.position++;var i=this.getExpression(),n=this.getExpression();t.push({type:"control",cmd:"move",direction:i,speed:n});break;case"shoot":this.position++;i=this.getExpression();t.push({type:"control",cmd:"shoot",direction:i});break;default:this.position++}}return e.commands=t,e}currentToken(){return this.tokens[this.position]}nextToken(){return this.tokens[this.position+1]}previousToken(){return this.tokens[this.position-1]}getExpression(){for(var e=this.getAtomic();void 0!==this.currentToken()&&("op"===this.currentToken().type||"equals"===this.currentToken().type||"or"===this.currentToken().value||"and"===this.currentToken().value);){var t=this.currentToken();this.position++;var o=this.getAtomic();e={type:"op",operator:t.value,right:o,left:e}}return e}getAtomic(){var e=null;if("word"===this.currentToken().type)e={type:"variable",value:this.currentToken().value};else if("string"===this.currentToken().type)e={type:"string",value:this.currentToken().value};else if("number"===this.currentToken().type)e={type:"number",value:this.currentToken().value};else if("function"===this.currentToken().type){var t=this.currentToken().value;this.position++;for(var o=[];null!=this.currentToken()&&")"!=this.currentToken().value;)if("("===this.currentToken().value||","===this.currentToken().value)this.position++;else{var s=this.getExpression();null!==s&&o.push(s)}e={type:"function",name:t,params:o}}else"("===this.currentToken().value?(this.position++,e=this.getExpression()):"-"===this.currentToken().value&&(this.position++,e={type:"number",value:"-"+this.currentToken().value});return this.position++,e}}const users=[];var rooms=[];function removeUser(e){users.splice(users.indexOf(e),1)}class User{constructor(e){this.socket=e,this.currentRoom=null,this.name="anon"}draw(){}}class Room{constructor(e,t){this.owner=e,this.locked=t,this.users=[],this.users=[],this.robots=[],this.width=600,this.height=300,this.running=!1}clear(){this.robots=[]}start(e){if(e===this.owner){this.running=!0;for(var t=0;t<this.users.length;t++)this.users[t].socket.emit("message","Simulation started")}else e.socket.emit("message","You are not the room owner.  You can't start the simulation.")}stop(e){if(e===this.owner){this.running=!1;for(var t=0;t<this.users.length;t++)this.users[t].socket.emit("message","Simulation stoped")}else e.socket.emit("message","You are not the room owner.  You can't stop the simulation.")}update(){if(this.running)for(var e=0;e<this.robots.length;e++)this.robots[e].update()}addUser(e){-1===this.users.indexOf(e)&&!1===this.locked&&this.users.push(e)}removeUser(e){-1!=this.users.indexOf(e)&&(this.users=this.users.slice(this.users.indexOf(e)+1));var t=this;0===this.users.length&&setTimeout(function(){0===t.users.length&&(rooms=rooms.slice(rooms.indexOf(t)+1))},5e3)}}function inteceptCircleLineSeg(e,t){var o,s,r,i,n,a,h,l,u,c;return c={},(u={}).x=t.p2.x-t.p1.x,u.y=t.p2.y-t.p1.y,c.x=t.p1.x-e.center.x,c.y=t.p1.y-e.center.y,o=u.x*c.x+u.y*c.y,s=2*(u.x*u.x+u.y*u.y),o*=-2,r=Math.sqrt(o*o-2*s*(c.x*c.x+c.y*c.y-e.radius*e.radius)),isNaN(r)?[]:(n=(o+r)/s,h={},l={},a=[],(i=(o-r)/s)<=1&&i>=0&&(h.x=t.p1.x+u.x*i,h.y=t.p1.y+u.y*i,a[0]=h),n<=1&&n>=0&&(l.x=t.p1.x+u.x*n,l.y=t.p1.y+u.y*n,a[a.length]=l),a)}function update(){for(var e in rooms)if(rooms[e].users.length>0){rooms[e].update();for(var t=0;t<rooms[e].users.length;t++){var o=[];for(var s in rooms[e].robots){var r=rooms[e].robots[s];o.push({x:r.x,y:r.y,direction:r.direction,size:r.size,name:r.name,energy:r.energy,turretDir:r.turretDir})}rooms[e].users[t].socket.emit("update",o)}}setTimeout(update,100)}function availableRoomUpdater(){var e=[];for(var t in rooms)e.push({name:t,numUsers:rooms[t].users.length});for(var o in users)users[o].socket.emit("availableRooms",e);setTimeout(availableRoomUpdater,1e3)}module.exports={io:e=>{const t=new User(e);users.push(t),e.on("disconnect",()=>{console.log("Disconnected: "+e.id),null!=t.currentRoom&&rooms[t.currentRoom].removeUser(t),removeUser(t)}),e.on("setName",e=>{t.name=e}),e.on("clear",()=>{null!=rooms[t.currentRoom]&&(rooms[t.currentRoom].owner===t?(rooms[t.currentRoom].clear(),e.emit("message","Cleared room")):e.emit("alert","not owner"))}),e.on("createRoom",(o,s)=>{""!==o?(rooms[o]=new Room(t,s),e.emit("createdRoom",o)):e.emit("alert","No room name specified.")}),e.on("enterRoom",o=>{null!=rooms[o]&&(!1===rooms[o].locked||rooms[o].owner===t?(rooms[o].addUser(t),t.currentRoom=o,e.emit("enteredRoom",o),console.log("Entered")):(e.emit("alert",o+" : locked"),console.log("Locked")))}),e.on("leaveRoom",o=>{null!=t.currentRoom&&(rooms[t.currentRoom].removeUser(t),t.currentRoom=null,e.emit("leftRoom"))}),e.on("start",()=>{null!==rooms[t.currentRoom]&&rooms[t.currentRoom].start(t)}),e.on("stop",()=>{null!==rooms[t.currentRoom]&&rooms[t.currentRoom].stop(t)}),e.on("addRobot",(o,s,r,i)=>{if(null!=t.currentRoom){var n=o.split(/\r?\n/),a=Math.floor(Math.random()*rooms[t.currentRoom].width),h=Math.floor(Math.random()*rooms[t.currentRoom].height),l=new Robot(n,s,r,a,h,0,rooms[t.currentRoom],i);rooms[t.currentRoom].robots.push(l),e.emit("message",i+" has entered the arena.")}}),console.log("Connected: "+e.id)},editor:(e,t)=>{t.send("Editor")}},setTimeout(update,100),setTimeout(availableRoomUpdater,100);